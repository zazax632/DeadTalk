<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeadTalk - ห้องสนทนา</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="room-container">
<h1>ห้องสนทนา</h1>
<p>รหัสห้อง: <span id="roomIdDisplay"></span></p>
<p>ผู้ใช้: <span id="usernameDisplayRoom"></span></p>

<div id="questionContainer">
<p id="currentQuestion">กำลังรอผู้เล่นคนที่ 2...</p>
<span id="timer">03:00</span>
</div>

<div id="messages" class="messages"></div>

<div class="chat-input">
<input type="text" id="msgInput" placeholder="พิมพ์ข้อความแล้วกด Enter">
<button id="sendBtn">ส่ง</button>
</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// ---------------------- Firebase Config ----------------------
const firebaseConfig = {
apiKey: "AIzaSyBWavAWu-Za3Q6n-cPJu2vBCWtpRLjbsEc",
authDomain: "deadtalk3-7bd8d.firebaseapp.com",
databaseURL: "https://deadtalk3-7bd8d-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "deadtalk3-7bd8d",
storageBucket: "deadtalk3-7bd8d.appspot.com",
messagingSenderId: "623956597741",
appId: "1:623956597741:web:3e16f6b3f3e16f6b3e16f6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------------- Questions ----------------------
const questions = [
"ถ้าวันนี้เป็นวันสุดท้ายของชีวิต คุณอยากทำอะไร?",
"อะไรคือสิ่งที่ทำให้คุณยิ้มได้เสมอ?",
"คุณเคยร้องไห้เพราะความสุขครั้งสุดท้ายเมื่อไหร่?",
"อะไรคือความทรงจำที่คุณอยากกลับไปอีกครั้ง?",
"คำถามอื่นๆ..."
];

// ---------------------- Room ----------------------
const urlParams = new URLSearchParams(window.location.search);
const username = urlParams.get('user');
const currentRoomId = urlParams.get('room');

document.getElementById('roomIdDisplay').textContent = currentRoomId;
document.getElementById('usernameDisplayRoom').textContent = username;

const messagesDiv = document.getElementById('messages');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');

const messagesRef = db.ref("rooms/" + currentRoomId + "/messages");
const statusRef = db.ref("status/" + currentRoomId);
const playersRef = db.ref("status/" + currentRoomId + "/players");

// ---------------------- Chat ----------------------
messagesRef.on('child_added', snap => {
const data = snap.val();
if (!data) return;
const div = document.createElement('div');
div.classList.add('msg');
div.textContent = `${data.user}: ${data.text}`;
messagesDiv.appendChild(div);
messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

function sendMessage() {
const text = msgInput.value.trim();
if (!text) return;
messagesRef.push({ user: username, text });
msgInput.value = "";
}
sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

// ---------------------- Question & Timer ----------------------
let questionStarted = false;

// ลงทะเบียนผู้เล่น (ไม่ลบของคนอื่น)
playersRef.update({ [username]: true });

// ตัวจับเวลาอัปเดตทุก 0.5 วินาที
setInterval(() => {
statusRef.once('value').then(snap => {
const data = snap.val();
if (!data || !data.startTime) return;
const elapsed = Math.floor((Date.now() - data.startTime) / 1000);
let remaining = 180 - elapsed;
if (remaining < 0) remaining = 0;
const m = String(Math.floor(remaining / 60)).padStart(2,'0');
const s = String(remaining % 60).padStart(2,'0');
document.getElementById('timer').textContent = `${m}:${s}`;
});
}, 500);

// ฟังจำนวนผู้เล่น
playersRef.on('value', snap => {
const players = snap.val() || {};
const playerCount = Object.keys(players).length;

// เริ่มคำถามและเวลาเมื่อมีผู้เล่น ≥ 2
if (!questionStarted && playerCount >= 2) {
questionStarted = true;
const firstQ = questions[Math.floor(Math.random() * questions.length)];
statusRef.update({ currentQuestion: firstQ, startTime: Date.now() });

// เปลี่ยนคำถามทุก 3 นาที
setInterval(() => {
const newQ = questions[Math.floor(Math.random() * questions.length)];
statusRef.update({ currentQuestion: newQ, startTime: Date.now() });
}, 3 * 60 * 1000);
}
});

// ฟังคำถามปัจจุบัน
statusRef.on('value', snap => {
const data = snap.val();
if (!data || !data.currentQuestion) return;
document.getElementById('currentQuestion').textContent = data.currentQuestion;
});

</script>
</body>
</html>
